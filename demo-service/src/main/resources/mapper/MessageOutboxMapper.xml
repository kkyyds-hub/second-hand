<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.demo.mapper.MessageOutboxMapper">

    <!-- 插入外箱记录 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO message_outbox (
            event_id,
            event_type,
            routing_key,
            exchange_name,
            biz_id,
            payload_json,
            status,
            retry_count,
            next_retry_time,
            created_at,
            updated_at
        ) VALUES (
                     #{eventId},
                     #{eventType},
                     #{routingKey},
                     #{exchangeName},
                     #{bizId},
                     #{payloadJson},
                     #{status},
                     #{retryCount},
                     #{nextRetryTime},
                     NOW(),
                     NOW()
                 )
    </insert>

    <!-- 根据 eventId 查询（幂等检查） -->
    <select id="selectByEventId" resultType="com.demo.entity.MessageOutbox">
        SELECT
            id,
            event_id     AS eventId,
            event_type   AS eventType,
            routing_key  AS routingKey,
            exchange_name AS exchangeName,
            biz_id       AS bizId,
            payload_json AS payloadJson,
            status,
            retry_count  AS retryCount,
            next_retry_time AS nextRetryTime,
            created_at   AS createdAt,
            updated_at   AS updatedAt
        FROM message_outbox
        WHERE event_id = #{eventId}
            LIMIT 1
    </select>

    <!-- 拉取待发送消息 -->
    <select id="listPending" resultType="com.demo.entity.MessageOutbox">
        SELECT
        id,
        event_id     AS eventId,
        event_type   AS eventType,
        routing_key  AS routingKey,
        exchange_name AS exchangeName,
        biz_id       AS bizId,
        payload_json AS payloadJson,
        status,
        retry_count  AS retryCount,
        next_retry_time AS nextRetryTime,
        created_at   AS createdAt,
        updated_at   AS updatedAt
        FROM message_outbox
        WHERE status IN ('NEW', 'FAIL')
        AND (next_retry_time IS NULL OR next_retry_time &lt;= NOW())
        ORDER BY id ASC
        LIMIT #{limit}
    </select>

    <!-- 标记发送成功 -->
    <update id="markSent">
        UPDATE message_outbox
        SET status = 'SENT',
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 标记发送失败（增加重试次数 + 设置下次重试时间） -->
    <update id="markFail">
        UPDATE message_outbox
        SET status = 'FAIL',
            retry_count = retry_count + 1,
            next_retry_time = #{nextRetryTime},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

<!-- 统计 Outbox 状态数量（监控用） -->
<select id="countByStatus" resultType="int">
    SELECT COUNT(*)
    FROM message_outbox
    WHERE status = #{status}
</select>

<!-- 统计指定状态累计重试次数（监控用） -->
<select id="sumRetryCountByStatus" resultType="int">
    SELECT COALESCE(SUM(retry_count), 0)
    FROM message_outbox
    WHERE status = #{status}
</select>

</mapper>
