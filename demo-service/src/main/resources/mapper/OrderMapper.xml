<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.demo.mapper.OrderMapper">

    <select id="listBuyerOrders" resultType="com.demo.vo.BuyerOrderSummary">
        SELECT
        o.id          AS orderId,
        o.order_no    AS orderNo,
        o.product_id  AS productId,
        p.title       AS productTitle,
        p.images      AS productThumbnail,  <!-- 如果以后有 thumbnail 字段，可以改成 p.thumbnail -->
        o.deal_price  AS dealPrice,
        o.quantity    AS quantity,
        u.nickname    AS sellerNickname,
        o.status      AS status,
        o.create_time AS createTime,
        o.pay_time    AS payTime
        FROM orders o
        JOIN products p ON o.product_id = p.id
        JOIN users    u ON o.seller_id = u.id
        WHERE o.buyer_id = #{buyerId}
        <!-- 如果有逻辑删除字段，这里可以加：AND o.is_deleted = 0 -->

        <!-- 状态过滤：PageQueryDTO.status 不为空才加条件 -->
        <if test="query.status != null and query.status != ''">
            AND o.status = #{query.status}
        </if>

        <!-- 排序字段白名单，防止 SQL 注入；把 createTime/payTime 映射到具体列名 -->
        <choose>
            <when test="query.sortField == 'createTime'">
                ORDER BY o.create_time
            </when>
            <when test="query.sortField == 'payTime'">
                ORDER BY o.pay_time
            </when>
            <!-- 其他字段一律默认按 create_time 排序 -->
            <otherwise>
                ORDER BY o.create_time
            </otherwise>
        </choose>

        <!-- 排序方向，仅允许 asc / desc，两种之外默认 desc -->
        <choose>
            <when test="query.sortOrder == 'asc'">
                ASC
            </when>
            <otherwise>
                DESC
            </otherwise>
        </choose>

    </select>
</mapper>