<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.demo.mapper.OrderMapper">

    <!-- 订单/商品状态：唯一口径（从枚举取 dbValue） -->
    <sql id="bindStatus">
        <bind name="OS_PENDING" value="@com.demo.enumeration.OrderStatus@PENDING.getDbValue()"/>
        <bind name="OS_PAID" value="@com.demo.enumeration.OrderStatus@PAID.getDbValue()"/>
        <bind name="OS_SHIPPED" value="@com.demo.enumeration.OrderStatus@SHIPPED.getDbValue()"/>
        <bind name="OS_COMPLETED" value="@com.demo.enumeration.OrderStatus@COMPLETED.getDbValue()"/>
        <bind name="OS_CANCELLED" value="@com.demo.enumeration.OrderStatus@CANCELLED.getDbValue()"/>

        <bind name="PS_ON_SALE" value="@com.demo.enumeration.ProductStatus@ON_SHELF.getDbValue()"/>
        <bind name="PS_SOLD" value="@com.demo.enumeration.ProductStatus@SOLD.getDbValue()"/>
    </sql>

    <update id="updateForShipping">
        <include refid="bindStatus"/>
        UPDATE orders
        SET
        shipping_company = #{shippingCompany},
        tracking_no      = #{trackingNo},
        shipping_remark  = #{shippingRemark},
        ship_time        = NOW(),
        status           = #{status},
        update_time      = NOW()
        WHERE
        id = #{id}
        AND seller_id = #{sellerId}
        AND status = #{OS_PAID}
    </update>


    <update id="updateForConfirm" parameterType="com.demo.entity.Order">
        <include refid="bindStatus"/>
        UPDATE orders
        SET
        status        = #{status},
        complete_time = #{completeTime},
        update_time   = #{updateTime}
        WHERE
        id = #{id}
        AND buyer_id = #{buyerId}
        AND status = #{OS_SHIPPED}
    </update>


    <insert id="insertOrder" useGeneratedKeys="true" keyProperty="id">
        <include refid="bindStatus"/>
        INSERT INTO orders (
        order_no, buyer_id, seller_id, total_amount, status,
        shipping_address, shipping_company, tracking_no, shipping_remark,
        create_time, pay_time, complete_time, update_time
        ) VALUES (
        #{orderNo}, #{buyerId}, #{sellerId}, #{totalAmount}, #{status},
        #{shippingAddress}, #{shippingCompany}, #{trackingNo}, #{shippingRemark},
        NOW(), NULL, NULL, NOW()
        )
    </insert>

    <insert id="insertOrderItem">
        <include refid="bindStatus"/>
        INSERT INTO order_items (
        order_id, product_id, price, quantity, create_time, update_time
        ) VALUES (
        #{orderId}, #{productId}, #{price}, #{quantity}, NOW(), NOW()
        )
    </insert>

    <update id="markProductSoldIfOnSale">
        <include refid="bindStatus"/>
        UPDATE products
        SET status = #{PS_SOLD},
        update_time = NOW()
        WHERE id = #{productId}
        AND status = #{PS_ON_SALE}
        AND is_deleted = 0
    </update>

    <select id="listBuyerOrders" resultType="com.demo.vo.order.BuyerOrderSummary">
        <include refid="bindStatus"/>
        SELECT
        o.id          AS orderId,
        o.order_no    AS orderNo,
        i.product_id  AS productId,
        p.title       AS productTitle,
        p.images      AS productThumbnail,  <!-- 保持你原来的口径 -->
        i.price       AS dealPrice,
        i.quantity    AS quantity,
        u.nickname    AS sellerNickname,
        o.status      AS status,
        o.shipping_company AS shippingCompany,
        o.tracking_no      AS trackingNo,
        o.ship_time        AS shipTime,
        o.complete_time    AS completeTime,
        o.create_time AS createTime,
        o.pay_time    AS payTime
        FROM orders o
        JOIN order_items i ON i.order_id = o.id
        JOIN products p    ON p.id       = i.product_id
        JOIN users u       ON o.seller_id = u.id
        WHERE o.buyer_id = #{buyerId}
        AND u.is_deleted = 0

        <!-- 状态过滤：PageQueryDTO.status 不为空才加条件 -->
        <if test="query.status != null and query.status != ''">
            AND o.status = #{query.status}
        </if>

        <!-- 排序字段白名单 -->
        <choose>
            <when test="query.sortField == 'createTime'">
                ORDER BY o.create_time
            </when>
            <when test="query.sortField == 'payTime'">
                ORDER BY o.pay_time
            </when>
            <otherwise>
                ORDER BY o.create_time
            </otherwise>
        </choose>

        <!-- 排序方向 -->
        <choose>
            <when test="query.sortOrder == 'asc'">
                ASC
            </when>
            <otherwise>
                DESC
            </otherwise>
        </choose>
    </select>

    <select id="listSellerOrders" resultType="com.demo.vo.order.SellerOrderSummary">
        <include refid="bindStatus"/>
        SELECT
        o.id               AS orderId,
        o.order_no         AS orderNo,
        i.product_id       AS productId,
        p.title            AS productTitle,
        -- 简单做法：从 images 字段中取第一个 URL，当缩略图
        SUBSTRING_INDEX(p.images, ',', 1) AS productThumbnail,
        i.price            AS dealPrice,
        i.quantity         AS quantity,
        u.nickname         AS buyerNickname,
        o.status           AS status,
        o.ship_time        AS shipTime,
        o.complete_time    AS completeTime,
        o.shipping_company AS shippingCompany,
        o.tracking_no      AS trackingNo,
        o.create_time      AS createTime,
        o.pay_time         AS payTime
        FROM orders o
        JOIN order_items i ON i.order_id = o.id
        JOIN products p    ON p.id        = i.product_id
        JOIN users u       ON u.id        = o.buyer_id
        WHERE
        o.seller_id = #{currentUserId}
        AND u.is_deleted = 0
        <if test="query.status != null and query.status != ''">
            AND o.status = #{query.status}
        </if>
        ORDER BY
        o.create_time DESC
    </select>

    <select id="getOrderDetail" resultType="com.demo.vo.order.OrderDetail">
        <include refid="bindStatus"/>
        SELECT
        -- 基础信息
        o.id            AS orderId,
        o.order_no      AS orderNo,
        o.status        AS status,
        o.total_amount  AS totalAmount,
        o.create_time   AS createTime,
        o.pay_time      AS payTime,
        o.complete_time AS completeTime,
        o.shipping_address AS shippingAddress,
        o.shipping_company AS shippingCompany,
        o.tracking_no      AS trackingNo,
        o.ship_time        AS shipTime,
        o.shipping_remark  AS shippingRemark,
        o.update_time      AS updateTime,

        -- 商品 + 明细（先按一单一个商品处理）
        i.quantity      AS quantity,
        i.price         AS dealPrice,
        p.id            AS productId,
        p.title         AS productTitle,
        SUBSTRING_INDEX(p.images, ',', 1) AS productThumbnail,
        p.images        AS productImages,

        -- 角色信息
        o.buyer_id      AS buyerId,
        bu.nickname     AS buyerNickname,
        o.seller_id     AS sellerId,
        su.nickname     AS sellerNickname

        FROM orders o
        JOIN order_items i ON i.order_id = o.id
        JOIN products p    ON p.id        = i.product_id
        JOIN users bu      ON bu.id       = o.buyer_id
        JOIN users su      ON su.id       = o.seller_id

        WHERE
        o.id = #{orderId}
        AND (o.buyer_id = #{currentUserId}
        OR o.seller_id = #{currentUserId})
        AND bu.is_deleted = 0
        AND su.is_deleted = 0
        LIMIT 1
    </select>

    <update id="updateForPay">
        <include refid="bindStatus"/>
        UPDATE orders
        SET status = #{OS_PAID},
        pay_time = NOW(),
        update_time = NOW()
        WHERE id = #{orderId}
        AND buyer_id = #{buyerId}
        AND status = #{OS_PENDING}
    </update>

    <update id="updateForCancel">
        <include refid="bindStatus"/>
        UPDATE orders
        SET status = #{OS_CANCELLED},
        cancel_time = NOW(),
        cancel_reason = #{reason},
        update_time = NOW()
        WHERE id = #{orderId}
        AND buyer_id = #{buyerId}
        AND status = #{OS_PENDING}
    </update>

    <update id="releaseProductsForOrder">
        <include refid="bindStatus"/>
        UPDATE products p
        JOIN order_items oi ON oi.product_id = p.id
        SET
        p.status = #{PS_ON_SALE},
        p.update_time = NOW()
        WHERE oi.order_id = #{orderId}
        AND p.status = #{PS_SOLD}
        AND p.is_deleted = 0
    </update>

    <select id="findTimeoutPendingOrderIds" resultType="java.lang.Long">
        <include refid="bindStatus"/>
        SELECT id
        FROM orders
        WHERE status = #{OS_PENDING}
        AND create_time <![CDATA[ <= ]]> #{deadline}
        ORDER BY create_time ASC
        LIMIT #{limit}
    </select>

    <update id="closeTimeoutOrder">
        <include refid="bindStatus"/>
        UPDATE orders
        SET status = #{OS_CANCELLED},
        cancel_time = NOW(),
        cancel_reason = 'timeout',
        update_time = NOW()
        WHERE id = #{orderId}
        AND status = #{OS_PENDING}
        AND create_time <![CDATA[ <= ]]> #{deadline}
    </update>

</mapper>
