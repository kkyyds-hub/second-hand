{
  "info": {
    "_postman_id": "day8-regression-collection",
    "name": "Day8 Regression (ALL GREEN)",
    "description": "Day8 系统加固与搜索优化回归测试集合\n覆盖：幂等性测试、搜索优化、订单完整流程、异常场景",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "01-Auth",
      "item": [
        {
          "name": "Buyer Login",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Response has token\", function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.code).to.eql(1);",
                  "  pm.expect(jsonData.data).to.have.property('token');",
                  "  // token 写入环境变量，供后续自动注入 authentication 头",
                  "  pm.environment.set(\"token_buyer\", jsonData.data.token);",
                  "  if (jsonData.data && jsonData.data.user && jsonData.data.user.id != null) { pm.environment.set(\"buyerId\", jsonData.data.user.id); }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"loginId\": \"{{buyer_username}}\",\n    \"password\": \"{{buyer_password}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/user/auth/login/password",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "auth",
                "login",
                "password"
              ]
            }
          }
        },
        {
          "name": "Seller Login",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Response has token\", function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.code).to.eql(1);",
                  "  pm.expect(jsonData.data).to.have.property('token');",
                  "  // token 写入环境变量，供后续自动注入 authentication 头",
                  "  pm.environment.set(\"token_seller\", jsonData.data.token);",
                  "  if (jsonData.data && jsonData.data.user && jsonData.data.user.id != null) { pm.environment.set(\"sellerId\", jsonData.data.user.id); }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"loginId\": \"{{seller_username}}\",\n    \"password\": \"{{seller_password}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/user/auth/login/password",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "auth",
                "login",
                "password"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "02-Search",
      "item": [
        {
          "name": "Search by Keyword in Title",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Response structure is valid\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(1);",
                  "    pm.expect(jsonData.data).to.have.property('list');",
                  "    pm.expect(jsonData.data).to.have.property('total');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/user/market/products?keyword=手机&page=1&pageSize=10",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "market",
                "products"
              ],
              "query": [
                {
                  "key": "keyword",
                  "value": "手机"
                },
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "pageSize",
                  "value": "10"
                }
              ]
            }
          }
        },
        {
          "name": "Search by Keyword in Description",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Response structure is valid\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(1);",
                  "    pm.expect(jsonData.data).to.have.property('list');",
                  "    pm.expect(jsonData.data).to.have.property('total');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/user/market/products?keyword=二手&page=1&pageSize=10",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "market",
                "products"
              ],
              "query": [
                {
                  "key": "keyword",
                  "value": "二手"
                },
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "pageSize",
                  "value": "10"
                }
              ]
            }
          }
        },
        {
          "name": "Get Market Product List (No Keyword)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Response structure is valid + pick products for Day8\", function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.code).to.eql(1);",
                  "  pm.expect(jsonData.data).to.have.property(\"list\");",
                  "  pm.expect(jsonData.data).to.have.property(\"total\");",
                  "  var list = (jsonData.data && Array.isArray(jsonData.data.list)) ? jsonData.data.list : [];",
                  "  pm.expect(list.length, \"市场列表为空：请确保至少有 on_sale 商品\").to.be.above(0);",
                  "",
                  "  // 需要 seller01 的商品，否则后续 /ship 会因为 sellerId 不匹配失败",
                  "  var sellerId = pm.environment.get(\"sellerId\");",
                  "  var candidates = list;",
                  "  if (sellerId) {",
                  "    var owned = list.filter(function (p) { return String(p.ownerId) === String(sellerId); });",
                  "    if (owned.length > 0) candidates = owned;",
                  "  }",
                  "",
                  "  // 去重提取 productId",
                  "  var seen = {};",
                  "  var ids = [];",
                  "  candidates.forEach(function (p) {",
                  "    var id = (p && p.productId != null) ? String(p.productId) : null;",
                  "    if (id && !seen[id]) { seen[id] = true; ids.push(id); }",
                  "  });",
                  "",
                  "  pm.expect(ids.length, \"seller01 的 on_sale 商品不足：至少需要 2 个（E2E + Negative）\").to.be.at.least(2);",
                  "  pm.environment.set(\"productId_e2e\", ids[0]);",
                  "  pm.environment.set(\"productId_negative\", ids[1]);",
                  "  // 兼容旧变量",
                  "  pm.environment.set(\"productId\", ids[0]);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/user/market/products?page=1&pageSize=10",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "market",
                "products"
              ],
              "query": [
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "pageSize",
                  "value": "10"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "03-Order-E2E",
      "item": [
        {
          "name": "Get Buyer Address List",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Response has address list\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(1);",
                  "    pm.expect(jsonData.data).to.be.an('array');",
                  "    if (jsonData.data && jsonData.data.length > 0) {",
                  "        var addr = jsonData.data[0];",
                  "        pm.environment.set(\"addressId\", addr.id);",
                  "        var addrStr = (addr.provinceName || '') + (addr.cityName || '') + (addr.districtName || '') + (addr.detailAddress || '');",
                  "        pm.environment.set(\"shippingAddress\", addrStr);",
                  "    } else {",
                  "        pm.environment.set(\"shippingAddress\", \"北京市朝阳区测试街道123号\");",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/user/addresses",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "addresses"
              ]
            }
          }
        },
        {
          "name": "Create Order",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var pid = pm.environment.get(\"productId_e2e\");",
                  "if (!pid) { throw new Error(\"productId_e2e 未设置：请先运行 02-Search / Get Market Product List (No Keyword)\"); }",
                  "var addr = pm.environment.get(\"shippingAddress\");",
                  "if (!addr) { pm.environment.set(\"shippingAddress\", \"北京市朝阳区测试街道123号\"); }"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Order created successfully\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(1);",
                  "    pm.expect(jsonData.data).to.have.property('orderId');",
                  "    pm.expect(jsonData.data.status).to.eql('pending');",
                  "    pm.environment.set(\"orderId\", jsonData.data.orderId);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"productId\": {{productId_e2e}},\n  \"shippingAddress\": \"{{shippingAddress}}\",\n  \"quantity\": 1\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{baseUrl}}/user/orders",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders"
              ]
            }
          }
        },
        {
          "name": "Pay Order",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Payment successful\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(1);",
                  "    pm.expect(jsonData.data).to.include('支付成功');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/user/orders/{{orderId}}/pay",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders",
                "{{orderId}}",
                "pay"
              ]
            }
          }
        },
        {
          "name": "Get Order Detail (After Pay)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Order status is paid\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(1);",
                  "    pm.expect(jsonData.data.status).to.eql('paid');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/user/orders/{{orderId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders",
                "{{orderId}}"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "04-Idempotency",
      "item": [
        {
          "name": "Prepare Idempotency (Reuse E2E Order)",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var oid = pm.environment.get(\"orderId\");",
                  "if (!oid) { throw new Error(\"orderId 未设置：请先跑完 03-Order-E2E / Create Order\"); }",
                  "pm.environment.set(\"orderId_idempotency\", oid);"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Prepare idempotency: orderId ready\", function () {",
                  "  var oid = pm.environment.get(\"orderId_idempotency\");",
                  "  pm.expect(oid, \"orderId_idempotency 不能为空\").to.be.ok;",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/user/orders/{{orderId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders",
                "{{orderId}}"
              ]
            }
          }
        },
        {
          "name": "Pay Order (First Time)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Idempotency: 支付\", function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.code).to.eql(1);",
                  "  var text = String(jsonData.data || jsonData.msg || \"\");",
                  "  // 允许：成功 / 已处理 / 无需重复操作 / 已完成",
                  "  pm.expect(text, \"返回文案不符合幂等口径\").to.match(/成功|无需重复|已|完成/);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/user/orders/{{orderId}}/pay",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders",
                "{{orderId}}",
                "pay"
              ]
            }
          }
        },
        {
          "name": "Pay Order (Second Time - Idempotency Test)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Idempotency: 支付\", function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.code).to.eql(1);",
                  "  var text = String(jsonData.data || jsonData.msg || \"\");",
                  "  // 允许：成功 / 已处理 / 无需重复操作 / 已完成",
                  "  pm.expect(text, \"返回文案不符合幂等口径\").to.match(/成功|无需重复|已|完成/);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/user/orders/{{orderId}}/pay",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders",
                "{{orderId}}",
                "pay"
              ]
            }
          }
        },
        {
          "name": "Ship Order (First Time)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Idempotency: 发货\", function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.code).to.eql(1);",
                  "  var text = String(jsonData.data || jsonData.msg || \"\");",
                  "  // 允许：成功 / 已处理 / 无需重复操作 / 已完成",
                  "  pm.expect(text, \"返回文案不符合幂等口径\").to.match(/成功|无需重复|已|完成/);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"shippingCompany\": \"SF\",\n    \"trackingNo\": \"SF9876543210\",\n    \"remark\": \"幂等性测试\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/user/orders/{{orderId}}/ship",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders",
                "{{orderId}}",
                "ship"
              ]
            }
          }
        },
        {
          "name": "Ship Order (Second Time - Idempotency Test)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Idempotency: 发货\", function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.code).to.eql(1);",
                  "  var text = String(jsonData.data || jsonData.msg || \"\");",
                  "  // 允许：成功 / 已处理 / 无需重复操作 / 已完成",
                  "  pm.expect(text, \"返回文案不符合幂等口径\").to.match(/成功|无需重复|已|完成/);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"shippingCompany\": \"SF\",\n    \"trackingNo\": \"SF9876543210\",\n    \"remark\": \"幂等性测试\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/user/orders/{{orderId}}/ship",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders",
                "{{orderId}}",
                "ship"
              ]
            }
          }
        },
        {
          "name": "Confirm Receipt (First Time)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Idempotency: 确认收货\", function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.code).to.eql(1);",
                  "  var text = String(jsonData.data || jsonData.msg || \"\");",
                  "  // 允许：成功 / 已处理 / 无需重复操作 / 已完成",
                  "  pm.expect(text, \"返回文案不符合幂等口径\").to.match(/成功|无需重复|已|完成/);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/user/orders/{{orderId}}/confirm-receipt",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders",
                "{{orderId}}",
                "confirm-receipt"
              ]
            }
          }
        },
        {
          "name": "Confirm Receipt (Second Time - Idempotency Test)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Idempotency: 确认收货\", function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.code).to.eql(1);",
                  "  var text = String(jsonData.data || jsonData.msg || \"\");",
                  "  // 允许：成功 / 已处理 / 无需重复操作 / 已完成",
                  "  pm.expect(text, \"返回文案不符合幂等口径\").to.match(/成功|无需重复|已|完成/);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/user/orders/{{orderId}}/confirm-receipt",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders",
                "{{orderId}}",
                "confirm-receipt"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "05-Negative",
      "item": [
        {
          "name": "Create Order for Negative Test",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var pid = pm.environment.get(\"productId_negative\");",
                  "if (!pid) { throw new Error(\"productId_negative 未设置：请先运行 02-Search / Get Market Product List (No Keyword)\"); }",
                  "var addr = pm.environment.get(\"shippingAddress\");",
                  "if (!addr) { addr = \"北京市朝阳区测试街道123号\"; pm.environment.set(\"shippingAddress\", addr); }"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Order created\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(1);",
                  "    if (jsonData.data && jsonData.data.orderId) {",
                  "        pm.environment.set(\"orderId_negative\", jsonData.data.orderId);",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"productId\": {{productId_negative}},\n  \"shippingAddress\": \"{{shippingAddress}}\",\n  \"quantity\": 1\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{baseUrl}}/user/orders",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders"
              ]
            }
          }
        },
        {
          "name": "Cancel Order",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Order cancelled\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(1);",
                  "    pm.expect(String(jsonData.data || \"\"), \"取消返回文案异常\").to.match(/取消成功|无需重复操作/);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{}"
            },
            "url": {
              "raw": "{{baseUrl}}/user/orders/{{orderId_negative}}/cancel",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders",
                "{{orderId_negative}}",
                "cancel"
              ]
            }
          }
        },
        {
          "name": "Ship Cancelled Order (Should Fail)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"HTTP status is 200/400\", function () {",
                  "  pm.expect(pm.response.code).to.be.oneOf([200, 400]);",
                  "});",
                  "pm.test(\"Should fail: cancelled order cannot be shipped\", function () {",
                  "  var jsonData = null;",
                  "  try { jsonData = pm.response.json(); } catch (e) {}",
                  "  if (jsonData) {",
                  "    pm.expect(jsonData.code).to.not.eql(1);",
                  "    var t = String(jsonData.msg || jsonData.data || \"\");",
                  "    pm.expect(t).to.match(/取消|无法|不允许|状态|已取消|cancell/i);",
                  "  } else {",
                  "    var t2 = pm.response.text();",
                  "    pm.expect(t2).to.match(/取消|无法|不允许|状态|已取消|cancell/i);",
                  "  }",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"shippingCompany\": \"SF\",\n    \"trackingNo\": \"SF1111111111\",\n    \"remark\": \"异常测试\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/user/orders/{{orderId_negative}}/ship",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders",
                "{{orderId_negative}}",
                "ship"
              ]
            }
          }
        },
        {
          "name": "Create Order for Unauthorized Ship Test",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var pid = pm.environment.get(\"productId_negative\");",
                  "if (!pid) { throw new Error(\"productId_negative 未设置：请先运行 02-Search / Get Market Product List (No Keyword)\"); }",
                  "var addr = pm.environment.get(\"shippingAddress\");",
                  "if (!addr) { addr = \"北京市朝阳区测试街道123号\"; pm.environment.set(\"shippingAddress\", addr); }"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Order created\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(1);",
                  "    if (jsonData.data && jsonData.data.orderId) {",
                  "        pm.environment.set(\"orderId_unauth\", jsonData.data.orderId);",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"productId\": {{productId_negative}},\n  \"shippingAddress\": \"{{shippingAddress}}\",\n  \"quantity\": 1\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{baseUrl}}/user/orders",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders"
              ]
            }
          }
        },
        {
          "name": "Pay Order for Unauthorized Test",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "pm.test(\"Pay should succeed (prepare unauthorized ship)\", function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.code).to.eql(1);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/user/orders/{{orderId_unauth}}/pay",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders",
                "{{orderId_unauth}}",
                "pay"
              ]
            }
          }
        },
        {
          "name": "Ship Order with Buyer Token (Should Fail)",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var token = pm.environment.get('token_buyer');",
                  "if (token) { pm.request.headers.upsert({ key: 'authentication', value: token }); }"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"HTTP status is 200/400\", function () {",
                  "  pm.expect(pm.response.code).to.be.oneOf([200, 400]);",
                  "});",
                  "pm.test(\"Should fail: only seller can ship\", function () {",
                  "  var jsonData = null;",
                  "  try { jsonData = pm.response.json(); } catch (e) {}",
                  "  if (jsonData) {",
                  "    pm.expect(jsonData.code).to.not.eql(1);",
                  "    var t = String(jsonData.msg || jsonData.data || \"\");",
                  "    pm.expect(t).to.match(/卖家|权限|无权|禁止|forbidden|not allowed/i);",
                  "  } else {",
                  "    var t2 = pm.response.text();",
                  "    pm.expect(t2).to.match(/卖家|权限|无权|禁止|forbidden|not allowed/i);",
                  "  }",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"shippingCompany\": \"SF\",\n    \"trackingNo\": \"SF2222222222\",\n    \"remark\": \"非卖家发货测试\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/user/orders/{{orderId_unauth}}/ship",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "user",
                "orders",
                "{{orderId_unauth}}",
                "ship"
              ]
            }
          }
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "var url = pm.request.url.toString();",
          "// Skip auth injection for login endpoints",
          "if (url.includes('/user/auth/login')) { return; }",
          "// If request already sets authentication header, respect it (e.g., negative tests)",
          "if (pm.request.headers.has('authentication')) { return; }",
          "var token = '';",
          "if (url.includes('/ship')) {",
          "    token = pm.environment.get('token_seller');",
          "} else {",
          "    token = pm.environment.get('token_buyer');",
          "}",
          "if (token) {",
          "    pm.request.headers.upsert({ key: 'authentication', value: token });",
          "}"
        ]
      }
    }
  ],
  "variable": []
}